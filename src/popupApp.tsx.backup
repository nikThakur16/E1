import { createHashRouter, RouterProvider, useNavigate, useLocation } from "react-router-dom";
import Layout from "./components/popup/Layout";
import PopupLogin from "./popupPages/PopupLogin";
import ProtectedRoute from "./components/popup/ProtectedRoute";
import PopUpHome from "./popupPages/PopUpHome";
import About from "./popupPages/About";
import RecordSection from "./popupPages/RecordSection";
import { useEffect } from "react";
import Processing from "./popupPages/Processing";
import UploadOptionsPage from "./popupPages/UploadOptionsPage";
import InputText from "./popupPages/InputText";
import UploadError from "./popupPages/UploadError";
import AudioProcessing from "./popupPages/AudioProcessing";
import SummaryPage from "./popupPages/SummaryPage";
import AIActionsPage from "./popupPages/AIActionsPage";
import LectureNotePage from "./popupPages/LectureNotePage";
import WebResetPassword from "./webPages/WebResetPassword";


function LayoutWithPersistence() {
  const navigate = useNavigate();
  const location = useLocation();

  useEffect(() => {
    // Check if user is authenticated
    const checkAuth = async () => {
      try {
        const result = await chrome?.storage?.local.get('token');
        const token = result?.token;
        
        if (!token) {
          // No token found, redirect to login
          if (location.pathname !== '/') {
            navigate('/');
          }
        } else {
          // Token exists, check if trying to access login page
          if (location.pathname === '/') {
            navigate('/home');
          }
        }
      } catch (error) {
        console.error('Error checking authentication:', error);
        // On error, redirect to login
        if (location.pathname !== '/') {
          navigate('/');
        }
      }
    };

    checkAuth();
  }, [navigate, location.pathname]);

  // Listen for storage changes (e.g., logout from another tab)
  useEffect(() => {
    const handleStorageChange = (changes: { [key: string]: chrome.storage.StorageChange }, areaName: string) => {
      if (areaName === 'local' && changes.token) {
        if (!changes.token.newValue) {
          // Token was removed, redirect to login
          navigate('/');
        }
      }
    };

    // Add listener for storage changes
    if (chrome?.storage?.onChanged) {
      chrome.storage.onChanged.addListener(handleStorageChange);
    }

    // Cleanup listener on unmount
    return () => {
      if (chrome?.storage?.onChanged) {
        chrome.storage.onChanged.removeListener(handleStorageChange);
      }
    };
  }, [navigate]);

  // Listen for messages from background script
  useEffect(() => {
    const handleMessage = (message: any) => {
      if (message.type === 'NAVIGATE_TO_SUMMARY') {
        navigate('/summary');
      } else if (message.type === 'NAVIGATE_TO_HOME') {
        navigate('/home');
      } else if (message.type === 'NAVIGATE_TO_RECORD') {
        navigate('/record');
      } else if (message.type === 'NAVIGATE_TO_UPLOAD') {
        navigate('/upload');
      } else if (message.type === 'NAVIGATE_TO_TEXT') {
        navigate('/text');
      } else if (message.type === 'NAVIGATE_TO_AI_ACTIONS') {
        navigate('/ai-actions');
      } else if (message.type === 'NAVIGATE_TO_LECTURE_NOTES') {
        navigate('/lecture-notes');
      }
    };

    // Add message listener
    if (chrome?.runtime?.onMessage) {
      chrome.runtime.onMessage.addListener(handleMessage);
    }

    // Cleanup listener on unmount
    return () => {
      if (chrome?.runtime?.onMessage) {
        chrome.runtime.onMessage.removeListener(handleMessage);
      }
    };
  }, [navigate, location.pathname]);

  return <Layout />;
}

const router = createHashRouter([
  {
    path: "/",
    element: <LayoutWithPersistence />,
    children: [
      {
        path: "/",
        element: <PopupLogin />,
      },
      {
        path: "/home",
        element: (
          <ProtectedRoute>
            {/* <SummaryPage   /> */}
            {/* <AIActionsPage /> */}
            {/* <LectureNotePage /> */}
            <PopUpHome />

          </ProtectedRoute>
        ),
      },
      {
        path: "/record",
        element: (
          <ProtectedRoute>
            <RecordSection />
          </ProtectedRoute>
        ),
      },
      {
        path: "/record/process",
        element: (
          <ProtectedRoute>
            <AudioProcessing />
          </ProtectedRoute>
        ),
      },
      {
        path:"/upload",
        element:(
          <ProtectedRoute>
            <UploadOptionsPage/>
          </ProtectedRoute>
        )

      },
      {
        path: "/upload/process",
        element: (
          <ProtectedRoute>
            <Processing />
          </ProtectedRoute>
        ),
      },
      {
        path: "/text",
        element: (
          <ProtectedRoute>
              <InputText/>
          </ProtectedRoute>
        ),
      },
      {
        path: "/summary",
        element: (
          <ProtectedRoute>
            <SummaryPage />
          </ProtectedRoute>
        ),
      },  
      {
        path: "/ai-actions",
        element: (
          <ProtectedRoute>
            <AIActionsPage />
          </ProtectedRoute>
        ),
      },
      {
        path: "/lecture-notes",
        element: (
          <ProtectedRoute>
            <LectureNotePage />
          </ProtectedRoute>
        ),
      },
   
    ],
  },
]);

export default function PopupApp() {
  return <RouterProvider router={router} />;
}
