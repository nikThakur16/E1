import { useState, useEffect } from "react";
import { useLocation } from "react-router-dom";
import Heading from "../components/popup/Heading";
import DropdownMenu from "../components/popup/DropdownMenu";
import BackButton from "../components/popup/BackButton";
import Button from "../components/comman/button";

interface BulletPoint {
  text: string;
  isNested: boolean;
}

interface ParsedContent {
  heading: string;
  description: string;
  bulletPoints: BulletPoint[];
}

export default function LectureNotePage() {
  const location = useLocation();
  const [data, setData] = useState<any>(null);
  const [menuOpen, setMenuOpen] = useState(false);
  const [content, setContent] = useState<ParsedContent[]>([]);
  const [expandedSections, setExpandedSections] = useState<{ [key: number]: boolean }>({});
  const [isLoading, setIsLoading] = useState(false);
  const [apiTitle, setApiTitle] = useState<string>("Lecture Notes");

  // Enhanced parsing function to handle markdown formatting from API response
  const parseContentFromResponse = (responseText: string): ParsedContent[] => {
    const lines = responseText.split("\n");
    const parsedContent: ParsedContent[] = [];
    let currentSection: ParsedContent | null = null;

    for (const line of lines) {
      const trimmedLine = line.trim();
      
      // Skip empty lines
      if (!trimmedLine) continue;

      // Check if it's a heading (## or **text**)
      if (trimmedLine.match(/^#+\s/) || trimmedLine.match(/^\*\*.*\*\*:?\*?\*?$/)) {
        // Save previous section if exists
        if (currentSection) {
          parsedContent.push(currentSection);
        }

        // Extract heading text
        let headingText = trimmedLine;
        
        if (trimmedLine.startsWith("##")) {
          headingText = trimmedLine.replace(/^#+\s/, "");
        } else if (trimmedLine.startsWith("#")) {
          headingText = trimmedLine.replace(/^#+\s/, "");
        } else if (trimmedLine.match(/^\*\*.*\*\*:?\*?\*?$/)) {
          headingText = trimmedLine.replace(/\*\*/g, "").replace(/:$/, "");
        }

        // Start new section
        currentSection = {
          heading: headingText,
          description: "",
          bulletPoints: [],
        };
      }
      // Check if it's a bullet point (*, -, or indented)
      else if (trimmedLine.match(/^[-•*]\s/) || line.match(/^\s+[-•*]\s/)) {
        // If no current section exists, create a default one
        if (!currentSection) {
          currentSection = {
            heading: "Summary Points",
            description: "",
            bulletPoints: [],
          };
        }
        
        const isNested = line.startsWith("    ") || line.startsWith("\t");
        let bulletText = trimmedLine.replace(/^[-•*]\s/, "");
        
        // Remove bold markers from bullet text
        bulletText = bulletText.replace(/\*\*/g, "");

        currentSection.bulletPoints.push({
          text: bulletText,
          isNested: isNested
        });
      }
      // It's description text
      else if (trimmedLine.length > 0) {
        // If no current section exists, create a default one
        if (!currentSection) {
          currentSection = {
            heading: "Summary",
            description: "",
            bulletPoints: [],
          };
        }
        
        currentSection.description += (currentSection.description ? " " : "") + trimmedLine;
      }
    }

    // Don't forget the last section
    if (currentSection) {
      parsedContent.push(currentSection);
    }

    return parsedContent;
  };

  // Handle Export to PDF
  const handleExportToPDF = () => {
    console.log("Export to PDF clicked");
    // Add your PDF export logic here
  };

  // Handle Delete
  const handleDelete = () => {
    console.log("Delete clicked");
    // Add your delete logic here
  };

  // Handle Copy
  const handleCopyContent = () => {
    const textToCopy = content
      .map(
        (item) =>
          `${item.heading}\n${item.description}\n${item.bulletPoints
            .map((point) => `${point.isNested ? "    " : ""}• ${point.text}`)
            .join("\n")}`
      )
      .join("\n\n");

    navigator.clipboard.writeText(textToCopy);
  };

  // Toggle show more for specific section
  const toggleShowMore = (sectionIndex: number) => {
    setExpandedSections(prev => ({
      ...prev,
      [sectionIndex]: !prev[sectionIndex]
    }));
  };

  // Handle back navigation
  const handleBack = () => {
    window.history.back();
  };

  // Render bullet point with proper formatting
  const renderBulletPoint = (point: BulletPoint, index: number) => {
    // Split by colon to make the label bold
    const parts = point.text.split(':');
    const hasLabel = parts.length > 1;
    
    return (
      <li 
        key={index} 
        className={`flex items-start gap-2 ${point.isNested ? 'ml-6' : ''}`}
      >
        <span className="text-[#4B5563] mt-1 flex-shrink-0">•</span>
        <span className="text-[16px] font-[400] leading-[152%]">
          {hasLabel ? (
            <>
              <span className="text-[16px] font-[600] text-[#1F2937]">{parts[0]}:</span>
              <span className="text-[#4B5563]">{parts.slice(1).join(':')}</span>
            </>
          ) : (
            <span className="text-[#4B5563]">{point.text}</span>
          )}
        </span>
      </li>
    );
  };

  useEffect(() => {
    // Check if we have API response data from navigation state
    if (location.state?.apiResponse) {
      setIsLoading(true);
      const apiResponse = location.state.apiResponse;
      const actionTitle = location.state.actionTitle;
      
      console.log("Received API Response:", apiResponse);
      console.log("Action Title:", actionTitle);
      
      // Extract the API title from action_details
      if (apiResponse?.data?.action_details?.title) {
        setApiTitle(apiResponse.data.action_details.title);
      }
      
      // Extract the content from API response - Updated to match your API structure
      let responseText = "";
      
      // Try different paths to find the content based on your API response structure
      if (apiResponse?.data?.action_result?.response_plain_text) {
        responseText = apiResponse?.data?.action_result?.response_plain_text;
      } else if (apiResponse?.data?.action_result?.response_body?.content) {
        responseText = apiResponse.data.action_result.response_body.content;
      } else if (apiResponse?.data?.content) {
        responseText = apiResponse.data.content;
      } else if (apiResponse?.content) {
        responseText = apiResponse.content;
      } else if (typeof apiResponse?.data === 'string') {
        responseText = apiResponse.data;
      } else if (typeof apiResponse === 'string') {
        responseText = apiResponse;
      } else {
        // Fallback: try to find any text content in the response
        responseText = JSON.stringify(apiResponse, null, 2);
      }
      
      console.log("Parsed response text:", responseText);
      
      // Parse the response content
      const parsedContent = parseContentFromResponse(responseText);
      setContent(parsedContent);
      setData(apiResponse);
      setIsLoading(false);
    } else {
      // No API response - show empty state
      setContent([]);
      setIsLoading(false);
    }
  }, [location.state]);

  if (isLoading) {
    return (
      <div className="bg-[#F4F8FF] flex flex-col justify-center items-center py-6 px-8">
        <div className="text-center mt-20 text-gray-500">
          <div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          Processing AI response...
        </div>
      </div>
    );
  }

  if (content.length === 0) {
    return (
      <div className="bg-[#F4F8FF] flex flex-col justify-center items-center py-6 px-8">
        <div className="w-full">
          <BackButton handleBack={handleBack} />
        </div>
        <div className="text-center mt-20 text-gray-500">
          No lecture notes available. Please generate some content first.
        </div>
      </div>
    );
  }

  return (
    <div className="bg-[#F4F8FF] flex flex-col justify-center items-center py-6 px-8">
      <div className="w-full">
        <BackButton handleBack={handleBack} />
      </div>

      <div className="w-full">
        {/* Header */}
        <div className="flex justify-between items-center mb-4">
          <div>{""}</div>
          <Heading title={apiTitle} />
          <div className="relative">
            <button
              onClick={() => setMenuOpen(!menuOpen)}
              className="p-1 rounded-full hover:bg-gray-100 cursor-pointer"
            >
              <img src="/popup/3Dot.svg" alt="3Dot" className="w-8 h-8" />
            </button>

            <DropdownMenu
              isOpen={menuOpen}
              onClose={() => setMenuOpen(false)}
              onExportPDF={handleExportToPDF}
              onDelete={handleDelete}
              onCopy={handleCopyContent}
              trianglePosition="right"
              width="w-44"
            />
          </div>
        </div>


        {/* Content Sections */}
        <div className="space-y-6">
          {content.map((item, itemIndex) => (
            <div key={itemIndex}>
              {/* Section Heading */}
              <h2 className="text-[18px] font-[600] text-[#1F2937] mb-3">
                {item.heading}
              </h2>
              
              {/* Description */}
              {item.description && (
                <p className="text-[16px] font-[400] text-[#4B5563] leading-[152%] mb-4">
                  {item.description}
                </p>
              )}

              {/* Bullet Points - Only show if section is expanded */}
              {item.bulletPoints.length > 0 && expandedSections[itemIndex] && (
                <ul className="space-y-2 mb-6">
                  {item.bulletPoints.map((point, pointIndex) => renderBulletPoint(point, pointIndex))}
                </ul>
              )}

              {/* Show More/Less button for sections that have bullet points */}
              {item.bulletPoints.length > 0 && (
                <button 
                  onClick={() => toggleShowMore(itemIndex)}
                  className="text-[#3F7EF8] text-[16px] font-[600] underline mb-6 cursor-pointer"
                >
                  {expandedSections[itemIndex] ? "Show Less" : "Show More"}
                </button>
              )}

              {/* Separator Line - Don't show for last section */}
              {itemIndex !== content.length - 1 && (
                <div className="w-full h-[1px] bg-[rgba(189,212,255,0.5)] mb-4"></div>
              )}
            </div>
          ))}
        </div>

        {/* Share Button */}
        <div className="mt-4 px-8 w-full">
          <Button title="Share" onClick={handleCopyContent} />
        </div>
      </div>
    </div>
  );
}
